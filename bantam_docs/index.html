
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Welcome to Bantam’s Documentation! &#8212; bantam  documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="welcome-to-bantam-s-documentation">
<h1>Welcome to Bantam’s Documentation!<a class="headerlink" href="#welcome-to-bantam-s-documentation" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and Tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</div>
<div class="section" id="module-bantam.web">
<span id="introduction"></span><h1>Introduction<a class="headerlink" href="#module-bantam.web" title="Permalink to this headline">¶</a></h1>
<p>Welcome to Bantam, a framework for running a web server, built on top of <em>aiohttp</em>,
poviding a convience-layer of abstraction.
The framework allows users to define a Python web API through static methods of classes,
and allows auto-generation of corresponding javascript APIs to match.  The developer need not
be concerned about the details of how to map routes nor to understand the details of HTTP transactions.
Ths developer need only focus on development of a web API as a Python interface.</p>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>Let’s look at setting up a simple WebApplication on your localhost:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">... </span><span class="kn">from</span> <span class="nn">bantam.web</span> <span class="kn">import</span> <span class="n">web_api</span><span class="p">,</span> <span class="n">RestMethod</span><span class="p">,</span> <span class="n">WebApplication</span>
<span class="gp">...</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Greetings</span><span class="p">:</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="nd">@web_api</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/html&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">RestMethod</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nd">@staticmethod</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">welcome</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="gp">... </span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="sd">        Welcome someone</span>
<span class="gp">...</span><span class="sd"></span>
<span class="gp">... </span><span class="sd">        :@param name: name of person to greet</span>
<span class="gp">... </span><span class="sd">        :return: a salutation of welcome</span>
<span class="gp">... </span><span class="sd">        &quot;&quot;&quot;</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;p&gt;Welcome, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="nd">@web_api</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/html&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">RestMethod</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nd">@staticmethod</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">goodbye</span><span class="p">(</span><span class="n">type_of_day</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="gp">... </span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="sd">        Tell someone goodbye by telling them to have a day (of the given type)</span>
<span class="gp">...</span><span class="sd"></span>
<span class="gp">... </span><span class="sd">        :@param type_of_day:  an adjective describe what type of day to have</span>
<span class="gp">... </span><span class="sd">        :return: a saltation of welcome</span>
<span class="gp">... </span><span class="sd">        &quot;&quot;&quot;</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;p&gt;Have a </span><span class="si">{</span><span class="n">type_of_day</span><span class="si">}</span><span class="s2"> day!&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>
<span class="gp">...</span>
<span class="gp">... </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">app</span> <span class="o">=</span> <span class="n">WebApplication</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">start</span><span class="p">())</span> <span class="c1"># default to localhost HTTP on port 8080</span>
</pre></div>
</div>
<p>Saving this to a file, ‘saultations.py’, you can run this start your server:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% python3 salutations.py
</pre></div>
</div>
<p>Then open a browser to the following URL’s:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://localhost:8080/Greetings/welcome?name=Bob">http://localhost:8080/Greetings/welcome?name=Bob</a></p></li>
<li><p><a class="reference external" href="http://localhost:8080/Greetings/goodbye?type_of_day=wonderful">http://localhost:8080/Greetings/goodbye?type_of_day=wonderful</a></p></li>
</ul>
<p>to display various salutiations.</p>
<p>To explain this code, the <em>&#64;web_api</em> decorator declares a method that is mapped to a route. The route is determined
by the class name, in this case <em>Greetings</em>, and the method name. Thus, the “welcome” method above, as a member of
<em>Greetings</em> class, is mapped to the route ‘/Greetings/welcome”.  There are some rules about methods declared as <em>&#64;web_api</em>:</p>
<ol class="arabic simple">
<li><p>They must be &#64;staticmethod’s.</p></li>
<li><p>They must provide all type hints for parameters and return value,</p></li>
<li><p>They must have parameters and return values of basic types (str, float, int bool) or a class that has both a serialize
and deserialize method to convert to/from bytes (Actually there’s a little more to this, explained later)</p></li>
</ol>
<p>The query parameters provided in the full URL are mapped to the parameters in the Python method.  For example,
the query parameter name=Box in the first uRL above maps to the <em>name</em> parameter of the <em>Greetings.welcome</em> method,
with ‘Bob’ as the value.
The query parameters are translated to the value and type expected by the
Python API. If the value is not convertible to the proper type, an error code along with reason are returned.
There are a few other options for parameters and return type that will be  discussed later on streaming.</p>
<p>The methods can also be declared as POST operations.  In this case, parameter values would be sent as part of the
payload of the request (not query parameters) as a simple JSON dictionary.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Although the code prevents name collisions, the underlying (automated) routes do not, and a route must be unique.
Thus, each pair of class/method declared as a &#64;web_api must be unique, including across differing modules.</p>
</div>
</div>
<p>The specific WebApplication API is simple, and only the <em>start</em> method is of importance:</p>
<dl class="py class">
<dt id="bantam.web.WebApplication">
<em class="property">class </em><code class="sig-prename descclassname">bantam.web.</code><code class="sig-name descname">WebApplication</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span></em>, <em class="sig-param"><span class="n">static_path</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>Union<span class="p">[</span>pathlib.Path<span class="p">, </span>str<span class="p">]</span><span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">js_bundle_name</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">router</span><span class="p">:</span> <span class="n">None</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">middlewares</span><span class="p">:</span> <span class="n">Iterable<span class="p">[</span>Callable<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">()</span></em>, <em class="sig-param"><span class="n">handler_args</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>Mapping<span class="p">[</span>str<span class="p">, </span>Any<span class="p">]</span><span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">client_max_size</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">1048576</span></em>, <em class="sig-param"><span class="n">debug</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="default_value">Ellipsis</span></em><span class="sig-paren">)</span><a class="headerlink" href="#bantam.web.WebApplication" title="Permalink to this definition">¶</a></dt>
<dd><p>Main class for running a WebApplication server. See the docs for <em>aiohttp</em> for information on the various
parameters.  Additional parameters are:</p>
<dl class="field-list simple">
<dt class="field-odd">&#64;param static_path</dt>
<dd class="field-odd"><p>root path to where static files will be kept, mapped to a route “/static”, if provided</p>
</dd>
<dt class="field-even">&#64;param js_bundle_name</dt>
<dd class="field-even"><p>the name of the javascript file, <strong>without</strong> exetnesion, where the client-side API
will be generated, if provided</p>
</dd>
</dl>
<dl class="py exception">
<dt id="bantam.web.WebApplication.DuplicateRoute">
<em class="property">exception </em><code class="sig-name descname">DuplicateRoute</code><a class="headerlink" href="#bantam.web.WebApplication.DuplicateRoute" title="Permalink to this definition">¶</a></dt>
<dd><p>Raised if an attempt is made to register a web_api function under an existing route</p>
</dd></dl>

<dl class="py method">
<dt id="bantam.web.WebApplication.start">
<em class="property">async </em><code class="sig-name descname">start</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">host</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>Union<span class="p">[</span>str<span class="p">, </span>Iterable<span class="p">[</span>str<span class="p">]</span><span class="p">]</span><span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">port</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>int<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">path</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">shutdown_timeout</span><span class="p">:</span> <span class="n">float</span> <span class="o">=</span> <span class="default_value">60.0</span></em>, <em class="sig-param"><span class="n">ssl_context</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>ssl.SSLContext<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">backlog</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">128</span></em>, <em class="sig-param"><span class="n">handle_signals</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">reuse_address</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>bool<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">reuse_port</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>bool<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span> &#x2192; None<a class="headerlink" href="#bantam.web.WebApplication.start" title="Permalink to this definition">¶</a></dt>
<dd><p>start the app</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>host</strong> – host of app, if TCP based</p></li>
<li><p><strong>port</strong> – port to handle requests on (to listen on) if TCP based</p></li>
<li><p><strong>path</strong> – path, if using UNIX domain sockets to listen on (cannot specify both TCP and domain parameters)</p></li>
<li><p><strong>shutdown_timeout</strong> – force shutdown if a shutdown call fails to take hold after this many seconds</p></li>
<li><p><strong>ssl_context</strong> – for HTTPS server; if not provided, will default to HTTP connection</p></li>
<li><p><strong>backlog</strong> – number of unaccepted connections before system will refuse new connections</p></li>
<li><p><strong>handle_signals</strong> – gracefully handle TERM signal or not</p></li>
<li><p><strong>reuse_address</strong> – tells the kernel to reuse a local socket in TIME_WAIT state, without waiting for its
natural timeout to expire. If not specified will automatically be set to True on UNIX.</p></li>
<li><p><strong>reuse_port</strong> – tells the kernel to allow this endpoint to be bound to the same port as other existing
endpoints are bound to, so long as they all set this flag when being created. This option is not supported
on Windows.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

<div class="section" id="module-bantam.js">
<span id="client-side-code-generation"></span><h2>Client-Side Code Generation<a class="headerlink" href="#module-bantam.js" title="Permalink to this headline">¶</a></h2>
<p>Bantam provides the ability to auto-generate client-side javascript code to abstract the details of makting
HTTP requests to the server.  This abstraction implies that the developer never need to know about routes,
formulating URLs, how to make a POST request, how to stream data over HTTP, etc!</p>
<p>To generate client side code, create a Python source file – let’s name it generator.py –
and import all of the classes containing &#64;web_api’s
to be generated. Then add the main entry poitn to generate the javascript code, like so:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">bantam.js</span> <span class="kn">import</span> <span class="n">JavascriptGenerator</span>
<span class="gp">... </span><span class="kn">from</span> <span class="nn">salutations</span> <span class="kn">import</span> <span class="n">Greetings</span>
<span class="gp">...</span>
<span class="gp">... </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;salutations.js&#39;</span><span class="p">,</span> <span class="s1">&#39;bw&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<span class="gp">... </span>       <span class="n">JavascriptGenerator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">skip_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Run the script as so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% python generate.py
</pre></div>
</div>
<p>With the above Greetings example, the generated javasctipt code will mimic the Python:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">javascript code auto-generated from Python server’s web API</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">bantam</span> <span class="p">{};</span>
<span class="nx">bantam</span><span class="p">.</span><span class="nx">salutations</span> <span class="o">=</span> <span class="kr">class</span> <span class="p">{};</span>
<span class="nx">bantam</span><span class="p">.</span><span class="nx">salutations</span><span class="p">.</span><span class="nx">Greetings</span> <span class="o">=</span> <span class="kr">class</span> <span class="p">{</span>
      <span class="nx">constructor</span><span class="p">(</span><span class="nx">site</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">site</span> <span class="o">=</span> <span class="nx">site</span><span class="p">;}</span>

      <span class="cm">/*</span>
<span class="cm">      Welcome someone</span>
<span class="cm">      The response will be provided as the (first) parameter passed into onsuccess</span>

<span class="cm">      @param {function(string) =&gt; null} onsuccess callback inoked, passing in response from server on success</span>
<span class="cm">      @param {function(int, str) =&gt; null}  onerror  callback upon error, passing in response code and status text</span>
<span class="cm">      @param {{string}} name name of person to greet</span>
<span class="cm">      */</span>
      <span class="nx">welcome</span><span class="p">(</span><span class="nx">onsuccess</span><span class="p">,</span> <span class="nx">onerror</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
         <span class="p">...</span>
      <span class="p">}</span>

       <span class="cm">/*</span>
<span class="cm">       Tell someone goodbye by telling them to have a day (of the given type)</span>
<span class="cm">       The response will be provided as the (first) parameter passed into onsuccess</span>

<span class="cm">       @param {function(string) =&gt; null} onsuccess callback inoked, passing in response from server on success</span>
<span class="cm">       @param {function(int, str) =&gt; null}  onerror  callback upon error, passing in response code and status text</span>
<span class="cm">       @param {{string}} type_of_day adjective describing type of day to have</span>
<span class="cm">       */</span>
      <span class="nx">goodbye</span><span class="p">(</span><span class="nx">onsuccess</span><span class="p">,</span> <span class="nx">onerror</span><span class="p">,</span> <span class="nx">type_of_day</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
      <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<p>The code maintains the same hierarchy in namespaces as modules in Python, albeit under a global <em>bantam</em> namespace.
This prevents potential namespace collisions.  The signatures of the API mimic those defined in the Pyhon codebase,
with the noted exception of the <em>onsuccess</em> and <em>onerror</em> callbacks as the first two parameters.
This is typical of how plain javascript handles asynchronous transactions:  rather than returning a value or raising an
exception, these callbacks are invoked instead, upon response from the server.</p>
<div class="section" id="generation-on-the-fly">
<h3>Generation on the fly<a class="headerlink" href="#generation-on-the-fly" title="Permalink to this headline">¶</a></h3>
<p>As an even greater convenience, the code can be generated on the fly, when the <em>WebApplication</em> is created.
By providing two parameters to the init call to your <em>WebApplication</em>:</p>
<ul class="simple">
<li><p><em>static_path</em>: the root path to serve static files</p></li>
<li><p><em>js_bundle_name</em>: the name (<strong>without</strong> extension) of the javascript bundle file</p></li>
</ul>
<p>the javascript code will be (re)generated just before startup of the server.  The javascript file that provides
the web API on the client side will then be available under the static route <em>/static/js/&lt;js-bundle-name&gt;.js</em>.</p>
<p>In the example above the instantiations of the <em>app</em> would be:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">WebApplication</span><span class="p">(</span><span class="n">static_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./static&quot;</span><span class="p">),</span> <span class="n">js_bundle_name</span><span class="o">=</span><span class="s1">&#39;salutations&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The client interface is then available through:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://localhost:8080/static/js/salutations.js">http://localhost:8080/static/js/salutations.js</a></p></li>
</ul>
<p>Through a simple normal declaration of an API in the Python code, and auto-generation of client code, the developer
is free to ignore the details of the inner works of routes and HTTP transactions.</p>
</div>
</div>
<div class="section" id="optional-parameters">
<h2>Optional Parameters<a class="headerlink" href="#optional-parameters" title="Permalink to this headline">¶</a></h2>
<p>If default parameter values are provided, they are optionally provided on the javascript client-side as well.
Additionally, to refine the second rule of declaring a web API above, the type for a parameter can also be
declared as an Optional to any the types declared there. Provided a default value, include <em>None</em>, is provided.</p>
</div>
<div class="section" id="streamed-responses">
<h2>Streamed Responses<a class="headerlink" href="#streamed-responses" title="Permalink to this headline">¶</a></h2>
<p>Responses can be streamed back to the client.  To do so, the underlying Python server call must be written as
an <em>AsyncGenerator</em>, returning a type <em>AsyncGenerator[None, &lt;int, float, bool, str, or bytes&gt;]</em>.   (Thus, ammending
the rule of allowed return values above).  Consider this example of a PoetryReader class:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Example of server code to stream a poem back to the client</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">bantam.decorators</span> <span class="kn">import</span> <span class="n">RestMethod</span>
<span class="kn">from</span> <span class="nn">bantam.web</span> <span class="kn">import</span> <span class="n">WebApplication</span><span class="p">,</span> <span class="n">web_api</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AsyncGenerator</span>

<span class="k">class</span> <span class="nc">PoetryReader</span><span class="p">:</span>
    <span class="n">POEM</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Mary had a little lamb...</span>
<span class="s2">    Its fleece was white as snow...</span>
<span class="s2">    Everywhere that Mary went...</span>
<span class="s2">    Her lamb was sure to go...</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nd">@web_api</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/streamed&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">RestMethod</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">read_poem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">PoetryReader</span><span class="o">.</span><span class="n">POEM</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">line</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># for dramatic effect</span>
        <span class="k">yield</span> <span class="s2">&quot;THE END&quot;</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">WebApplication</span><span class="p">(</span><span class="n">static_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">js_bundle_name</span><span class="o">=</span><span class="s1">&#39;poetry_reader&#39;</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>  <span class="c1"># default to localhost HTTP on port 8080</span>
</pre></div>
</div>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>The method must be declared as POST to work consistently across different machines/web browsers</p>
</div>
<p>The javascript generated for such an API is the same, with the exception that the <em>onsuccess</em> callback will be
named <em>onreceive</em> and will be called with two parameters.  The first is the “chunk” that is read and the second
is a boolean indicating whether it is the final one or not.  The “chunks” are determine by the type yielded by
the generator:</p>
<ul class="simple">
<li><dl class="simple">
<dt>for numeric or <em>bool</em> types: each number yielded will invoke a single callback to <em>onreceive</em>.  But be aware that multiple</dt><dd><p>values can be sent at a time and that the generated javascript code will handle the logic to split them up.
This is particularly true when there is no or short sleep periods between yields.</p>
</dd>
</dl>
</li>
<li><p>for <em>str</em> type: <em>onreceive</em> will be called for each line received, guaranteeing whole lines are provided</p></li>
<li><p>for <em>bytes</em> type: <em>cnreceive</em> will be called for each chunk of bytes received, regardless of size</p></li>
</ul>
<p>Here is a bit of HTML to implement the client-side:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">HTML containing client-side code for handling streaming responses</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span> <span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
 <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/static/js/poetry_reader.js&quot;</span> <span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
 <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
 <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
 <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;poem&#39;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
 <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
     <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>

         <span class="kd">let</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bantam</span><span class="p">.</span><span class="nx">__main__</span><span class="p">.</span><span class="nx">PoetryReader</span><span class="p">(</span><span class="s2">&quot;http://localhost:8080&quot;</span><span class="p">);</span>
         <span class="kd">let</span> <span class="nx">html</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
         <span class="kd">let</span> <span class="nx">onreceive</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">is_done</span><span class="p">){</span>
              <span class="nx">html</span> <span class="o">+=</span> <span class="s2">&quot;&lt;p&gt;&quot;</span> <span class="o">+</span> <span class="nx">line</span> <span class="o">+</span> <span class="s2">&quot;&lt;/p&gt;&lt;br/&gt;&quot;</span><span class="p">;</span>
              <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;poem&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">html</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="nx">reader</span><span class="p">.</span><span class="nx">read_poem</span><span class="p">(</span><span class="nx">onreceive</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">reason</span><span class="p">){</span>
             <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;UNEXPECTED ERROR OCCURRED: &quot;</span> <span class="o">+</span> <span class="nx">code</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="nx">reason</span><span class="p">);</span>
         <span class="p">});</span>
     <span class="p">});</span>
 <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
 <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
 <span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<p>Loading the page <a class="reference external" href="http://localhost:8080/static/index.html">http://localhost:8080/static/index.html</a> will execute the code.</p>
</div>
</div>
<div class="section" id="streaming-requests">
<h1>Streaming Requests<a class="headerlink" href="#streaming-requests" title="Permalink to this headline">¶</a></h1>
<p>You can also make requests that stream (upload) data to the server.  Here again, we add two more (final) allowable
types for parameters that specify a parameter provides an (async) iterator for lopping over and sending data chunk
by chunk:</p>
<ul class="simple">
<li><p><em>bantam.web.AsyncLineGIterator</em>: specifies that the client will send <em>str</em> data to the server line by line (without
any return character present in the line)</p></li>
<li><p><em>bantam.web.AsyncChunkIterator</em>: specifies that the iterator will send <em>bytes</em> of data to the server</p></li>
</ul>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>At most one parameter may be specified as an iterator type</p>
</div>
<p>Here is what a web API method would look like that captures uploaded byts of data to a file and reports progress
back to the client:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Example code for Python web API method that streams data</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="k">class</span> <span class="nc">Uploader</span><span class="p">:</span>
     <span class="nd">@web_api</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/html&#39;</span><span class="p">)</span>
     <span class="nd">@staticmethod</span>
     <span class="k">async</span> <span class="k">def</span> <span class="nf">receive_streamed_data</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">byte_data</span><span class="p">:</span> <span class="n">AsyncChunkGenerator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
         <span class="n">bytes_received</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">packet_size</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># bytes</span>
         <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;some_file_path&#39;</span><span class="p">,</span> <span class="s1">&#39;bw&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
             <span class="k">async</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">byte_data</span><span class="p">(</span><span class="n">packet_size</span><span class="p">):</span>
                 <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">byte_data</span><span class="p">)</span>
                 <span class="n">bytes_received</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_data</span><span class="p">)</span>
                 <span class="n">progress</span> <span class="o">=</span> <span class="n">bytes_received</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">size</span>
                 <span class="k">yield</span> <span class="n">progress</span>
</pre></div>
</div>
</div>
<p>As a side note, when a streaming parameter is specified, all others will be sent as query parameters even when the request is
POST.  Note that for chunk iterators, the parameter byte_data will be a callable that takes a single parameter,
which is the max size of packet to be read each chunk.  The line iterator will be a simple iterator, not a callable.
That is for a line itertor the Python code would look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="k">class</span> <span class="nc">Uploader</span><span class="p">:</span>
    <span class="nd">@web_api</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/html&#39;</span><span class="p">)</span>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">receive_streamed_data</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">line_by_line</span><span class="p">:</span> <span class="n">AsyncLineGenerator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="o">...</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;some_file_path&#39;</span><span class="p">,</span> <span class="s1">&#39;bw&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">line_by_line</span><span class="p">:</span>  <span class="c1">#&lt;====  NOT a function call as in AsyncChunkIterator</span>
               <span class="o">...</span>
</pre></div>
</div>
<p>On the client side, the signature of the API will look similar, with the <em>onsuccess</em> (<em>onreceive</em> if the
response is also streaming) and <em>onerror</em> callbacks act the same.  The differences are that:</p>
<ol class="arabic simple">
<li><p>the parameter that is the AsyncLine[Chunk]Iterator will not be present in the signature</p></li>
<li><p>insted, the javascript API call will return a function to be called by the client to send each chunk of data (ad
the first and only parameter of the function)</p></li>
</ol>
<p>An example of uploading a file using the above api (assuming the Uploader class belongs to the module <em>uploads</em>):</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="kd">let</span> <span class="nx">onreceive</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">progress</span><span class="p">,</span> <span class="nx">is_done</span><span class="p">){</span>
   <span class="p">...</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">reason</span><span class="p">){</span>
   <span class="p">...</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">uploader</span> <span class="o">=</span> <span class="nx">bantam</span><span class="p">.</span><span class="nx">uploads</span><span class="p">.</span><span class="nx">Uploader</span><span class="p">(</span><span class="nx">site_url</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">size_of_upload</span> <span class="o">=</span> <span class="mf">1024</span><span class="o">*</span><span class="mf">1024</span><span class="p">;</span>  <span class="c1">// bytes</span>
<span class="kd">let</span> <span class="nx">send_byte_data</span> <span class="o">=</span> <span class="nx">uploader</span><span class="p">.</span><span class="nx">receive_streamed_data</span><span class="p">(</span><span class="nx">onreceive</span><span class="p">,</span> <span class="nx">onerror</span><span class="p">,</span> <span class="nx">size_of_upload</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">send_byte_data</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span> <span class="c1">// assumng file is a file object created prior to this code</span>
</pre></div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="#">bantam</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="#">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, John Rusnak.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/index.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>